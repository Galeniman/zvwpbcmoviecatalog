@page
@using System.Globalization
@using MovieCatalogApi.Entities
@using System.Text.RegularExpressions
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

@{
    var genreCounts = Model.GenresWithCounts.Values;
    var minTitlesInGenres = genreCounts.Any() ? genreCounts.Min() : 0;
    var maxTitlesInGenres = genreCounts.Any() ? genreCounts.Max() : 0;
}

<div class="row">
    @*<div class="col-md-4 col-12  text-center" style="font-size: 0.8em">
        <div>
            @foreach (var genreWithCount in Model.GenresWithCounts.OrderBy(g => g.Key.Name))
            {
                var titlesInGenre = genreWithCount.Value;
                double range = maxTitlesInGenres - minTitlesInGenres;
                double weight = (range > 0)
                    ? (titlesInGenre - minTitlesInGenres) / range
                    : 0;
                double size = 1.0 + weight;

                string sizeAsString = size.ToString("N3", CultureInfo.InvariantCulture);

                <span class="text-nowrap" style="font-size: @(sizeAsString)em"><text>@genreWithCount.Key.Name</text>(<small class="text-muted">@genreWithCount.Value</small>)</span>
            }
        </div>
        <hr class="d-block d-md-none" />
    </div>*@
    <div class="col-md-4 col-12  text-center" style="font-size: 0.8em">
        <div class="row">
            <a asp-page="/Title" class="btn btn-primary">Add a new movie</a>
        </div>
    <form method="get" class="row mt-3">
        <div class="col-12 mb-3 pb-3 border-bottom text-center">
            <label asp-for="Filter.Genres" class="fw-bold">Genres</label>
            <div>
                @foreach (var genreWithCount in Model.GenresWithCounts.OrderBy(g => g.Key.Name))
                {
                    var genreName = genreWithCount.Key.Name;
                    var count = genreWithCount.Value;
                    bool isChecked = Model.Filter.Genres?.Contains(genreName) ?? false;

                    double range = maxTitlesInGenres - minTitlesInGenres;
                    double weight = (range > 0)
                        ? (count - minTitlesInGenres) / range
                        : 0;
                    double size = 1.0 + weight;

                    string sizeAsString = size.ToString("N3", CultureInfo.InvariantCulture);

                    <div class="form-check form-check-inline">
                        <input @(isChecked ? "checked" : string.Empty)
                               id="Filter.Genres[@genreName]" type="checkbox"  name="Filter.Genres" value="@genreName"
                                   class="form-check-input" style="transform: scale(@sizeAsString); transform-origin: top; margin-right: calc((@size - 1) * 1.1em); margin-top: calc((@size - 1) * 0.4em);" />
                            <label class="form-check-label" for="Filter.Genres[@genreName]" style="font-size: @(sizeAsString)em">@genreName (@count)</label>
                    </div>
                }
            </div>
        </div>
        <div class="col-12 mb-3 pb-3 border-bottom text-center">
            <label asp-for="Filter.TitleContains" class="fw-bold">Title</label>
            <div class="row justify-content-center">
                <div class="col-8">
                    <input asp-for="Filter.TitleContains" class="form-control" />
                </div>
            </div>
        </div>
        <div class="col-12 mb-3 pb-3 border-bottom text-center">
            <label asp-for="Filter.TitleTypes" class="fw-bold">Type</label>
            <div>
                @foreach (var tn in Enum.GetNames(typeof(TitleType)))
                {
                    string typeName = Regex.Replace(tn, "(?<!^)([A-Z])", " $1").Trim();
                    typeName = typeName.Replace("Tv", "TV");

                    <div class="form-check form-check-inline">
                        <input @(Model.Filter.TitleTypes?.Any(t => t.ToString() == tn) ?? false ? "checked" : string.Empty)
                               id="Filter.TitleTypes[@tn]" type="checkbox" name="Filter.TitleTypes" value="@tn"
                               class="form-check-input" />
                        <label class="form-check-label" for="Filter.TitleTypes[@tn]">@typeName</label>
                    </div>
                }
            </div>
        </div>
        <div class="col-12 mb-3 pb-3 border-bottom">
            <label asp-for="Filter.StartYearMin" class="fw-bold">Year of release</label>
            <div class="row justify-content-center">
                <div class="col-auto">
                    <input asp-for="Filter.StartYearMin" class="form-control" min="1900" max="2100" />
                </div>
                <div class="col-auto text-center">-</div>
                <div class="col-auto">
                    <input asp-for="Filter.StartYearMax" class="form-control" min="1900" max="2100" />
                </div>
            </div>
        </div>
        <div class="col-12 mb-3 pb-3 border-bottom">
            <label asp-for="Filter.EndYearMin" class="fw-bold">Year of finale (serials only)</label>
            <div class="row justify-content-center">
                <div class="col-auto">
                    <input asp-for="Filter.EndYearMin" class="form-control" min="1900" max="2100" />
                </div>
                <div class="col-auto text-center">-</div>
                <div class="col-auto">
                    <input asp-for="Filter.EndYearMax" class="form-control" min="1900" max="2100" />
                </div>
            </div>
        </div>
        <div class="col-12 mb-3 pb-3 border-bottom">
            <label asp-for="Filter.RuntimeMinutesMin" class="fw-bold">Runtime (minutes)</label>
            <div class="row justify-content-center">
                <div class="col-auto">
                    <input asp-for="Filter.RuntimeMinutesMin" class="form-control" min="1" max="9999" />
                </div>
                <div class="col-auto text-center">-</div>
                <div class="col-auto">
                    <input asp-for="Filter.RuntimeMinutesMax" class="form-control" min="1" max="999" />
                </div>
            </div>
        </div>
        @foreach (var (key, value) in Request.Query
                .Where(kv => !kv.Key.StartsWith("Filter.")))
        {
            <input type="hidden" name="@key" value="@value" />
        }
        <div class=" row">
            <button type="submit" class="btn btn-primary fw-bold">Filter titles</button>
        </div>
    </form>
    </div>
    <div class="col-md-8 col-12">
        <nav class="text-center mb-2">
            <div class="m-2 border">@Model.Titles.AllResultsCount results.</div>
            @if (Model.Titles.Results.Count > 0)
            {
                <ul class="pagination row g-0" style="font-size: 0.8em">
                    @{
                        var last = 0;
                    }
                    @foreach (var i in Model.PageNumberOptions)
                    {
                        if (last != i - 1)
                        {
                            <li class="page-item col g-0">
                                <i class="page-link text-muted">...</i>
                            </li>
                        }
                        last = i;
                        <li class="page-item col @(i == Model.PageNumber ? "active font-weight-bold" : "")">
                            <a class="page-link" asp-all-route-data="Request.Query.ToDictionary(v => v.Key, v => v.Value.ToString())"
                               asp-route-PageNumber="@i">
                                @i
                            </a>
                        </li>
                    }
                </ul>
            }
            <div class="row">
                <div class="col">
                    <form method="get">
                        <label for="sPageSize">Page size</label>
                        <select id="sPageSize" class="form-control" asp-for="PageSize" asp-items="Model.PageSizeOptions" onchange="$(this).parent().submit()">
                        </select>
                        @foreach (var (key, value) in Request.Query
                                                .Where(q => q.Key != nameof(Model.PageSize) && q.Key != nameof(Model.PageNumber)))
                        {
                            <input type="hidden" name="@key" value="@value" />
                        }
                        <input type="hidden" asp-for="PageNumber" value="1" />
                    </form>
                </div>
                <div class="col">
                    <form method="get">
                        <label for="sTitleSort">Ordered by</label>
                        <select id="sTitleSort" class="form-control" asp-for="TitleSort" asp-items="Model.TitleSortOptions" onchange="$(this).parent().submit()">
                        </select>
                        @foreach (var (key, value) in Request.Query
                                                .Where(q => q.Key != nameof(Model.TitleSort) && q.Key != nameof(Model.PageNumber)))
                        {
                            <input type="hidden" name="@key" value="@value" />
                        }
                        <input type="hidden" asp-for="PageNumber" value="1" />
                    </form>
                </div>
                <div class="col">
                    <form method="get">
                        <label for="sTitleSort">Order direction</label>
                        <select id="sSortDescending" class="form-control" asp-for="SortDescending" asp-items="Model.SortDirectionOptions" onchange="$(this).parent().submit()">
                        </select>
                        @foreach (var (key, value) in Request.Query
                                                .Where(q => q.Key != nameof(Model.SortDescending) && q.Key !=
                                                nameof(Model.PageNumber)))
                        {
                            <input type="hidden" name="@key" value="@value" />
                        }
                        <input type="hidden" asp-for="PageNumber" value="1" />
                    </form>
                </div>
            </div>
        </nav>
        <div class="row">
            @foreach (var movie in Model.LatestMovies)
            {
                <div class="col-6 col-lg-4">
                    <div class="card">
                        <div class="card-body">
                            <a asp-page="/Title" asp-route-Id="@movie.Id">
                                <h5>
                                    <text>@movie.PrimaryTitle</text>
                                    @if (movie.StartYear != null)
                                    {
                                        <small class="text-muted">
                                            (@($"{movie.StartYear}{(movie.EndYear != null ? "-" + movie.EndYear : "")}"))
                                        </small>
                                    }
                                </h5>
                            </a>
                            @if (!string.Equals(movie.OriginalTitle, movie.PrimaryTitle, StringComparison.OrdinalIgnoreCase))
                            {
                            <h6 class="text-muted"><i><text>@movie.OriginalTitle</text></i></h6>
                            }
                            <span class="badge rounded-pill bg-primary text-nowrap">
                                @{
                                    string typeName = movie.TitleType.ToString();
                                    typeName = System.Text.RegularExpressions.Regex
                                        .Replace(typeName, "(?<!^)([A-Z])", " $1")
                                        .Trim();

                                    typeName = typeName.Replace("Tv", "TV");
                                }
                                @typeName
                            </span>
                            @foreach (var titleGenre in movie.TitleGenres)
                            {
                                <span class="badge rounded-pill bg-secondary text-nowrap" href="/"><text>@titleGenre.Genre.Name</text></span>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>
